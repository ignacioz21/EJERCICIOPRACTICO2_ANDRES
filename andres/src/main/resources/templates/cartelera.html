<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<body th:replace="layout :: body" th:with="contenido='cartelera :: contenido'">

<div th:fragment="contenido">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5">
                <i class="fas fa-calendar-alt me-3"></i>Cartelera de Funciones
            </h1>
            <p class="lead text-muted">Descubre nuestras películas en cartelera y reserva tus entradas</p>
        </div>
    </div>

    <!-- Filtros y búsqueda (opcional) -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" placeholder="Buscar película..." id="buscarPelicula">
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary active" data-filter="all">
                    Todas
                </button>
                <button type="button" class="btn btn-outline-secondary" data-filter="today">
                    Hoy
                </button>
                <button type="button" class="btn btn-outline-secondary" data-filter="tomorrow">
                    Mañana
                </button>
            </div>
        </div>
    </div>

    <!-- Lista de funciones -->
    <div class="row" th:if="${funciones and !funciones.empty}">
        <div class="col-md-6 col-lg-4 mb-4" th:each="funcion : ${funciones}">
            <div class="card h-100 shadow-sm">
                <!-- Imagen de la película (si está disponible) -->
                <div class="position-relative">
                    <img th:if="${funcion.pelicula.imagenUrl}" 
                         th:src="${funcion.pelicula.imagenUrl}" 
                         class="card-img-top" 
                         alt="Poster"
                         style="height: 300px; object-fit: cover;">
                    <div th:unless="${funcion.pelicula.imagenUrl}" 
                         class="card-img-top bg-secondary d-flex align-items-center justify-content-center"
                         style="height: 300px;">
                        <i class="fas fa-film fa-3x text-white"></i>
                    </div>
                    
                    <!-- Badge de clasificación -->
                    <span th:if="${funcion.pelicula.clasificacion}" 
                          class="badge bg-warning text-dark position-absolute top-0 end-0 m-2"
                          th:text="${funcion.pelicula.clasificacion}">PG-13</span>
                </div>

                <div class="card-body d-flex flex-column">
                    <!-- Título de la película -->
                    <h5 class="card-title" th:text="${funcion.pelicula.titulo}">Título de la Película</h5>
                    
                    <!-- Información básica -->
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-tags me-1"></i>
                            <span th:text="${funcion.pelicula.genero}">Género</span>
                        </small>
                        <br>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            <span th:text="${funcion.pelicula.duracion}">120</span> min
                        </small>
                    </div>

                    <!-- Descripción (truncada) -->
                    <p class="card-text flex-grow-1" 
                       th:text="${#strings.abbreviate(funcion.pelicula.descripcion, 100)}">
                        Descripción de la película...
                    </p>

                    <!-- Información de la función -->
                    <div class="border-top pt-3 mt-auto">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Fecha:</small>
                                <br>
                                <strong th:text="${#temporals.format(funcion.fechaFuncion, 'dd/MM/yyyy')}">15/08/2025</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Hora:</small>
                                <br>
                                <strong th:text="${#temporals.format(funcion.horaInicio, 'HH:mm')}">19:00</strong>
                            </div>
                        </div>
                        
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Sala:</small>
                                <br>
                                <strong th:text="${funcion.sala.nombreSala}">Sala 1</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Precio:</small>
                                <br>
                                <strong class="text-success">
                                    $<span th:text="${funcion.precio}">8.50</span>
                                </strong>
                            </div>
                        </div>

                        <!-- Asientos disponibles -->
                        <div class="mt-2">
                            <small class="text-muted">Asientos disponibles:</small>
                            <br>
                            <span class="badge" 
                                  th:classappend="${funcion.asientosDisponibles > 20 ? 'bg-success' : (funcion.asientosDisponibles > 5 ? 'bg-warning text-dark' : 'bg-danger')}"
                                  th:text="${funcion.asientosDisponibles}">50</span>
                        </div>

                        <!-- Botón de reserva -->
                        <div class="d-grid mt-3">
                            <a sec:authorize="isAuthenticated()" 
                               th:href="@{/reservas/nueva/{id}(id=${funcion.id})}"
                               class="btn btn-primary"
                               th:disabled="${funcion.asientosDisponibles == 0}">
                                <i class="fas fa-ticket-alt me-2"></i>
                                <span th:if="${funcion.asientosDisponibles > 0}">Reservar Entradas</span>
                                <span th:unless="${funcion.asientosDisponibles > 0}">Agotado</span>
                            </a>
                            
                            <a sec:authorize="!isAuthenticated()" 
                               th:href="@{/login}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión para Reservar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje si no hay funciones -->
    <div th:if="${funciones == null or funciones.empty}" class="row">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <h4>No hay funciones disponibles</h4>
                <p>Actualmente no tenemos funciones programadas. Vuelve pronto para ver nuestros próximos estrenos.</p>
                <a th:href="@{/}" class="btn btn-primary">
                    <i class="fas fa-home me-2"></i>Volver al Inicio
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Script para filtros básicos
document.addEventListener('DOMContentLoaded', function() {
    const buscarInput = document.getElementById('buscarPelicula');
    const filtros = document.querySelectorAll('[data-filter]');
    const tarjetas = document.querySelectorAll('.card');

    // Búsqueda por texto
    if (buscarInput) {
        buscarInput.addEventListener('input', function() {
            const termino = this.value.toLowerCase();
            tarjetas.forEach(function(tarjeta) {
                const titulo = tarjeta.querySelector('.card-title').textContent.toLowerCase();
                const mostrar = titulo.includes(termino);
                tarjeta.closest('.col-md-6').style.display = mostrar ? 'block' : 'none';
            });
        });
    }

    // Filtros por fecha
    filtros.forEach(function(filtro) {
        filtro.addEventListener('click', function() {
            // Remover clase active de todos los filtros
            filtros.forEach(f => f.classList.remove('active'));
            // Agregar clase active al filtro clickeado
            this.classList.add('active');

            const filtroTipo = this.getAttribute('data-filter');
            // Aquí podrías implementar lógica de filtrado por fecha
            console.log('Filtrar por:', filtroTipo);
        });
    });
});
</script>

</body>
</html>